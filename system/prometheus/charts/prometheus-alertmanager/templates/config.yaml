apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-alertmanager

data:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m

    templates: 
      - ./*.tmpl

    inhibit_rules:
    # Mute warnings for which also a critical alert exists. Per context and
    # cluster.
    - source_match:
        severity: 'critical'
      target_match:
        severity: 'warning'
      equal: ['context']

    route:
      group_by: ['cluster', 'alertname']
      group_wait: 1m
      group_interval: 15m
      repeat_interval: 8h
      receiver: slack-catchall 

      routes:
      - receiver: 'slack-alerts'
        continue: true
        match_re:
          service: k8s|etcd
        routes:
        - receiver: 'slack-kubernetes'
          match:
            severity: critical

    receivers:
    - name: slack-catchall
      slack_configs:
      - api_url: {{ default "MISSING" .Values.slack_webhook_url | quote }}
        username: "Kubernetes Control Plane"
        channel: '#prometheus-alerts'
        title: {{"'{{template \"slack.sapcc.title\" . }}'"}}
        title_link: {{"'{{template \"slack.sapcc.titlelink\" . }}'"}}
        text: {{"'{{template \"slack.sapcc.text\" . }}'"}}
        pretext: {{"'{{template \"slack.sapcc.pretext\" . }}'"}}
        icon_emoji: {{"'{{template \"slack.sapcc.iconemoji\" . }}'"}}


    - name: slack-alerts
      slack_configs:
      - api_url: {{ default "MISSING" .Values.slack_webhook_url | quote }}
        username: "Kubernetes Control Plane"
        channel: '#ccalerts'
        title: {{"'{{template \"slack.sapcc.title\" . }}'"}}
        title_link: {{"'{{template \"slack.sapcc.titlelink\" . }}'"}}
        text: {{"'{{template \"slack.sapcc.text\" . }}'"}}
        pretext: {{"'{{template \"slack.sapcc.pretext\" . }}'"}}
        icon_emoji: {{"'{{template \"slack.sapcc.iconemoji\" . }}'"}}

    - name: slack-kubernetes
      slack_configs:
      - api_url: {{ default "MISSING" .Values.slack_webhook_url | quote }}
        username: "Kubernetes Control Plane"
        channel: '#sig-kubernetes'
        title: {{"'{{template \"slack.sapcc.title\" . }}'"}}
        title_link: {{"'{{template \"slack.sapcc.titlelink\" . }}'"}}
        text: {{"'{{template \"slack.sapcc.text\" . }}'"}}
        pretext: {{"'{{template \"slack.sapcc.pretext\" . }}'"}}
        icon_emoji: {{"'{{template \"slack.sapcc.iconemoji\" . }}'"}}

  {{- $files := .Files }}
  {{ range tuple "slack.tmpl" }}
  {{ . }}: |
{{ $files.Get . | indent 4 }}
  {{- end }}

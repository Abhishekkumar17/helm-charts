apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-maia

data:
  ca.cert: |
{{ .Values.prometheus.ca | indent 4}}
  bearer_token_file: |
{{ .Values.prometheus.token | indent 4 }}
  prometheus.yaml: |
    global:
      scrape_timeout: 55s

    scrape_configs:
      # Scrape config for service endpoints.
      #
      # The relabeling allows the actual service scrape endpoint to be configured
      # via the following annotations:
      #
      # * `prometheus.io/scrape`: Only scrape services that have a value of `true`
      # * `prometheus.io/scheme`: If the metrics endpoint is secured then you will need
      # to set this to `https` & most likely set the `tls_config` of the scrape config.
      # * `prometheus.io/path`: If the metrics path is not `/metrics` override this.
      # * `prometheus.io/port`: If the metrics are exposed on a different port to the
      # service then set this appropriately.

    - job_name: 'maia/pods'
      tls_config:
        ca_file: /etc/prometheus/ca.cert
      bearer_token_file: /etc/prometheus/bearer_token_file
      scheme: https
      kubernetes_sd_configs:
      - api_server: "https://apiserver.{{.Values.global.region}}.{{.Values.global.domain}}"
        role: pod
      relabel_configs:
      - action: keep
        source_labels: [__meta_kubernetes_namespace]
        regex: maia
      - action: replace
        source_labels: [__meta_kubernetes_pod_node_name]
        target_label: instance

    - job_name: 'maia/endpoints'
      tls_config:
        ca_file: /etc/prometheus/ca.cert
      bearer_token_file: /etc/prometheus/bearer_token_file
      scheme: https
      kubernetes_sd_configs:
      - api_server: "https://apiserver.{{.Values.global.region}}.{{.Values.global.domain}}"
        role: endpoints
      relabel_configs:
      - action: keep
        source_labels: [__meta_kubernetes_namespace]
        regex: maia
      - action: replace
        source_labels: [__meta_kubernetes_pod_node_name]
        target_label: instance

    - job_name: 'maia/services'
      tls_config:
        ca_file: /etc/prometheus/ca.cert
      bearer_token_file: /etc/prometheus/bearer_token_file
      scheme: https
      kubernetes_sd_configs:
      - api_server: "https://apiserver.{{.Values.global.region}}.{{.Values.global.domain}}"
        role: service
      relabel_configs:
      - action: keep
        source_labels: [__meta_kubernetes_namespace]
        regex: maia
      - action: replace
        source_labels: [__meta_kubernetes_pod_node_name]
        target_label: instance

    - job_name: 'prometheus-maia'
      static_configs:
        - targets: ['localhost:9090']
